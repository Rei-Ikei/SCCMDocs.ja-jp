---
title: "スクリプトを作成して実行する"
titleSuffix: Configuration Manager
description: "クライアント デバイスで PowerShell スクリプトを作成して実行する"
ms.custom: na
ms.date: 11/29/2017
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-app
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: cc230ff4-7056-4339-a0a6-6a44cdbb2857
caps.latest.revision: "14"
caps.handback.revision: "0"
author: BrucePerlerMS
ms.author: bruceper
manager: angrobe
ms.openlocfilehash: 1472f697ae8b82e6268433aa6398fcc10a429994
ms.sourcegitcommit: 5f4a584d4a833b0cc22bd8c47da7dd55aced97fa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/05/2017
---
# <a name="create-and-run-powershell-scripts-from-the-configuration-manager-console"></a>Configuration Manager コンソールから PowerShell スクリプトを作成して実行する

*適用対象: System Center Configuration Manager (Current Branch)*

>[!TIP]
>PowerShell スクリプトを実行する機能は、バージョン 1706 で導入されたプレリリース機能です。 スクリプトを有効にする方法については、「[System Center Configuration Manager のプレリリース機能](/sccm/core/servers/manage/pre-release-features)」を参照してください。

PowerShell スクリプトを実行する機能と System Center Configuration Manager の統合を改善しました。 PowerShell には、高度な自動化されたスクリプトを作成できるという利点があります。PowerShell スクリプトは、多くの方が参加するコミュニティで理解され、共有されています。 このスクリプトを使用すると、ソフトウェアを管理するカスタム ツールを簡単に構築できます。また、大規模なジョブをより簡単に、一貫した方法で実行できるので、日常のタスクをすぐに完了できるようになります。

PowerShell スクリプトは System Center Configuration Manager と統合されているので、*スクリプトの実行*機能を使用して以下を実行できます。

- System Center Configuration Manager と共に使用するようにスクリプトを作成して編集する。
- ロールとセキュリティ スコープを使用してスクリプトの使用法を管理する。 
- コレクションまたは個々のオンプレミスの管理対象 Windows PC でスクリプトを実行する。
- クライアント デバイスから高速に集計されたスクリプト結果を取得する。
- スクリプトの実行を監視し、スクリプトの出力からレポート結果を表示する。

>[!WARNING]
>スクリプトを利用する場合は、目的を持って注意して使用することをお勧めします。 分離されたロールとスコープという、開発時に役立つ追加の保護策も組み込まれています。 意図しないスクリプトの実行を防ぐために、実行前にスクリプトが正しいことを検証し、信頼できる発行元のスクリプトであることを確認してください。 拡張文字や他の難読化を配慮し、スクリプトのセキュリティ保護について学習してください。

## <a name="prerequisites"></a>必要条件

- PowerShell スクリプトを実行するには、クライアントで PowerShell バージョン 3.0 以降を実行している必要があります。 ただし、実行するスクリプトに、より新しいバージョンの PowerShell の機能が含まれている場合、スクリプトを実行するクライアントがそのバージョンの PowerShell を実行している必要があります。
- Configuration Manager クライアントがスクリプトを実行するには、1706 リリース以降のクライアントを実行している必要があります。
- スクリプトを使用するには、適切な Configuration Manager のセキュリティ ロールのメンバーである必要があります。
- スクリプトをインポートおよび作成するには: **完全な権限を持つ管理者**のセキュリティ ロールで、**SMS スクリプト**への**作成**アクセス許可がアカウントに付与されている必要があります。
- スクリプトを承認または拒否するには: **完全な権限を持つ管理者**のセキュリティ ロールで、**SMS スクリプト**への**承認**アクセス許可がアカウントに付与されている必要があります。
- スクリプトを実行するには: **完全な権限を持つ管理者**のセキュリティ ロールで、**コレクション**への**スクリプトの実行**アクセス許可がアカウントに付与されている必要があります。

Configuration Manager のセキュリティ ロールの詳細については、「[ロール ベース管理の基礎](/sccm/core/understand/fundamentals-of-role-based-administration)」を参照してください。

## <a name="limitations"></a>制限事項

現在、スクリプトの実行は以下をサポートしています。

- スクリプト言語: PowerShell
- パラメーターの型: 整数、文字列、リスト

## <a name="run-script-authors-and-approvers"></a>スクリプトの実行の作成者と承認者

スクリプトの実行では、スクリプトの実装と実行に別のロールとして*スクリプト作成者*と*スクリプト承認者*の概念を使用しています。 作成者ロールと承認者ロールが分かれているので、スクリプトの実行という強力なツールの重要なプロセス チェックが可能になります。

### <a name="scripts-roles-control"></a>スクリプト ロールの制御

既定では、ユーザーは自分が作成したスクリプトを承認できません。 スクリプトは強力で用途が広く、多くのデバイスに展開できるため、スクリプトを作成する人と、そのスクリプトを承認する人とでロールを分けることができます。 ロールを分けることで、監視なしのスクリプト実行に対してセキュリティ レベルがさらに高くなります。 テストの場合は、便宜的にこの 2 つ目の承認を無効にすることもできます。

### <a name="approve-or-deny-a-script"></a>スクリプトの承認または拒否

スクリプトを実行するには、*スクリプト承認者*ロールが事前に承認する必要があります。 スクリプトを承認するには、次の手順を実行します。

1. Configuration Manager コンソールで、**[ソフトウェア ライブラリ]**をクリックします。
2. **[ソフトウェア ライブラリ]** ワークスペースで **[スクリプト]** をクリックします。
3. **[スクリプト]** リストで、承認または拒否するスクリプトを選択し、**[ホーム]** タブの **[スクリプト]** グループで、**[承認]/[拒否]** をクリックします。
4. **[スクリプトの承認/拒否]** ダイアログ ボックスで、スクリプトの **[承認]** または **[拒否]** を選択し、必要に応じて決定に関するコメントを入力します。  スクリプトを拒否すると、クライアント デバイスでそのスクリプトを実行できません。 <br>
![スクリプト - 承認](./media/run-scripts/RS-approval.png)
5. ウィザードを完了します。 **[スクリプト]** リストの **[承認状態]** 列は、行った操作に応じて変わります。

### <a name="allow-users-to-approve-their-own-scripts"></a>ユーザーが自身のスクリプトを承認できるようにする

この承認は、主にスクリプト開発のテスト フェーズで使用されます。

1. Configuration Manager コンソールで、**[管理]** をクリックします。
2. **[管理]** ワークスペースで **[サイトの構成]** を展開して、**[サイト]** をクリックします。
3. サイトの一覧で、自分のサイトを選択し、**[ホーム]** タブの **[サイト]** グループで **[階層設定]** をクリックします。
4. **[階層設定のプロパティ]** ダイアログ ボックスの **[全般]** タブで、**[Do not allow script authors to approve their own scripts]\(スクリプト作成者に自身のスクリプトの承認を許可しない\)** チェック ボックスをオフにします。

>[!IMPORTANT]
>ベスト プラクティスとして、スクリプト作成者に自分のスクリプトの承認を許可しないようにする必要があります。 これは、ラボ環境でのみ許可する必要があります。 運用環境でこの設定を変更する場合の影響を慎重に検討してください。

## <a name="security-scopes"></a>セキュリティ スコープ
*(バージョン 1710 で導入されました)*  
スクリプトの実行は、Configuration Manager の既存の機能であるセキュリティ スコープを使用し、ユーザー グループを表すタグを割り当てることで、スクリプトの作成と実行を制御しています。 セキュリティ スコープの使用の詳細については、「[System Center Configuration Manager のロール ベース管理の構成](../../core/servers/deploy/configure/configure-role-based-administration.md)」を参照してください。

## <a name="create-a-script"></a>スクリプトの作成

1. Configuration Manager コンソールで、**[ソフトウェア ライブラリ]**をクリックします。
2. **[ソフトウェア ライブラリ]** ワークスペースで **[スクリプト]** をクリックします。
3. **[ホーム]** タブの **[作成]** グループで、**[スクリプトの作成]** をクリックします。
4. **スクリプトの作成**ウィザードの **[スクリプト]** ページで、次の設定を構成します。
    - **[スクリプト名]**: スクリプトの名前を入力します。 同じ名前の複数のスクリプトを作成できますが、重複する名前を使用すると、Configuration Manager コンソールで必要なスクリプトを見つけるのがより困難になります。
    - **[スクリプト言語]**: 現時点では、PowerShell スクリプトのみがサポートされています。
    - **[インポート]**: PowerShell スクリプトをコンソールにインポートします。 スクリプトは **[スクリプト]** フィールドに表示されます。
    - **[クリア]**: [スクリプト] フィールドから現在のスクリプトを削除します。
    - **[スクリプト]**: 現在インポートされたスクリプトが表示されます。 必要に応じて、このフィールドでスクリプトを編集できます。
1. ウィザードを完了します。 新しいスクリプトが**[承認を待っています]**の状態で **[スクリプト]** リストに表示されます。 このスクリプトをクライアント デバイスで実行するには、先にそのスクリプトを承認する必要があります。

## <a name="script-parameters"></a>スクリプト パラメーター
*(バージョン 1710 で導入されました)*  
スクリプトにパラメーターを追加すると、作業の柔軟性が向上します。 ここでは、スクリプトの実行機能の現在の機能とスクリプト パラメーター (*文字列*、*整数*データ型) の概要について説明します。 プリセット値の一覧も掲載します。 スクリプトにサポートされないデータ型が含まれている場合は、警告を受け取ります。

**[スクリプトの作成]** ダイアログの **[スクリプト]** で **[スクリプト パラメーター]** をクリックします。

スクリプトの各パラメーターには独自のダイアログがあり、詳細や検証を追加できます。

### <a name="parameter-validation"></a>パラメーターの検証

スクリプト内の各パラメーターには、そのパラメーターに検証を追加するための **[Script Parameter Properties]\(スクリプト パラメーター プロパティ\)** ダイアログがあります。 検証を追加した後に、その検証を満たしていないパラメーターの値を入力すると、エラーが発生します。

#### <a name="example-firstname"></a>例: *FirstName*

この例では、文字列パラメーター *FirstName* のプロパティを設定できます。

![スクリプトのパラメーター - 文字列](./media/run-scripts/RS-parameters-string.png)


**[スクリプト パラメーターのプロパティ]** ダイアログの検証セクションでは、次のフィールドを使用できます。

- **[最小の長さ]** - *[FirstName]* フィールドの最小の文字数。
- **[最大の長さ]** - *[FirstName]* フィールドの最大の文字数。
- **[RegEx]** - *正規表現 (Regular Expression)* の短縮形。 正規表現の使用方法については、次のセクション「*正規表現による検証を使用する*」をご覧ください。
- **[カスタム エラー]** - システム検証エラー メッセージの代わりに使う独自のカスタム エラー メッセージを追加するのに役立ちます。

#### <a name="using-regular-expression-validation"></a>正規表現による検証を使用する

正規表現はプログラミングのコンパクトな形式で、エンコードされた検証に対して文字列をチェックします。 たとえば、*[RegEx]* フィールドに `[^A-Z]` を指定することによって、*[FirstName]* フィールド内の大文字アルファベット文字の有無をチェックすることができます。

このダイアログ ボックスの正規表現処理は、.NET Framework でサポートされています。 正規表現の使用方法の詳細については、「[.NET の正規表現](https://docs.microsoft.com/dotnet/standard/base-types/regular-expressions)」をご覧ください。 


## <a name="script-examples"></a>スクリプトの例

この機能で利用する可能性があるスクリプトの例をいくつか紹介します。

### <a name="create-a-new-folder-and-file"></a>新しいフォルダーとファイルの作成

このスクリプトは、入力した名前に基づいて新しいフォルダーを作成し、その中にファイルを作成します。

``` powershell
Param(
[Parameter(Mandatory=$True)]
[string]$FolderName,
[Parameter(Mandatory=$True)]
[string]$FileName,
)

New-Item $FolderName -type directory
New-Item $FileName -type file
```

### <a name="get-os-version"></a>OS バージョンの取得

このスクリプトは WMI を使用してコンピューターに OS バージョンを照会します。

``` powershell
Write-Output (Get-WmiObject -Class Win32_operatingSystem).Caption
```

## <a name="run-a-script"></a>[スクリプトの実行]

スクリプトが承認されたら、1 つのデバイスまたはコレクションに対してそのスクリプトを実行できます。 スクリプトは実行が始まると、優先度の高いシステムを使用してすばやく起動され、1 時間以内にタイムアウトします。 そしてスクリプトの結果は、状態メッセージ システムを使用して返されます。

スクリプトのターゲットのコレクションを選択するには、以下の操作を行います。

1. Configuration Manager コンソールで、**[資産とコンプライアンス]** をクリックします。
2. [資産とコンプライアンス] ワークスペースで **[デバイス コレクション]** をクリックします。
3. **[デバイス コレクション]** リストで、スクリプトを実行するデバイスのコレクションをクリックします。
4. コレクションを選択し、**[スクリプトの実行]** をクリックします。
5. **スクリプトの実行**ウィザードの **[スクリプト]** ページで、リストからスクリプトを選択します。 承認済みスクリプトのみが表示されます。
6. **[次へ]** をクリックして、ウィザードを完了します。

>[!IMPORTANT]
>ターゲット デバイスの電源が 1 時間のあいだ切れているなどの理由で、スクリプトが実行されない場合は、再実行する必要があります。

### <a name="target-machine-execution"></a>ターゲット コンピューターの実行

スクリプトは、対象となるクライアントの*システム* アカウントまたは*コンピューター* アカウントとして実行されます。 このアカウントのネットワーク アクセスは制限されています。 スクリプトによるリモート システムおよびリモートの場所へのアクセスは、その点を考慮して準備する必要があります。

## <a name="script-monitoring"></a>スクリプトの監視

デバイスのコレクション上でスクリプトの実行を開始した後は、次の手順で操作を監視します。 バージョン 1710 以降、スクリプトの実行時にリアルタイムで監視し、特定のスクリプトの実行についてレポートに返すこともできるようになりました。 <br>

![スクリプト モニター - スクリプトの実行ステータス](./media/run-scripts/RS-monitoring-three-bar.png)

1. Configuration Manager コンソールで、**[監視]** をクリックします。
2. **[監視]** ワークスペースで、**[スクリプトのステータス]** をクリックします。
3. **[スクリプトのステータス]** リストには、クライアント デバイスで実行した各スクリプトの結果が表示されます。 スクリプトの終了コード **0** は、通常、スクリプトが正常に実行されたことを示します。

## <a name="see-also"></a>関連項目

- [System Center Configuration Manager のロール ベース管理の構成](../../core/servers/deploy/configure/configure-role-based-administration.md)
- [ロール ベース管理の基礎](/sccm/core/understand/fundamentals-of-role-based-administration)

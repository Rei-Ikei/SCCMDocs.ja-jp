---
title: "スクリプトを作成して実行する"
titleSuffix: Configuration Manager
description: "クライアント デバイスで PowerShell スクリプトを作成して実行する"
ms.custom: na
ms.date: 11/20/2017
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-app
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: cc230ff4-7056-4339-a0a6-6a44cdbb2857
caps.latest.revision: "14"
caps.handback.revision: "0"
author: BrucePerlerMS
ms.author: bruceper
manager: angrobe
ms.openlocfilehash: 964f6d39c4c1afc82ff4336821740923d27cd569
ms.sourcegitcommit: 12d0d53e47bbf1a0bbd85015b8404a44589d1e14
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/21/2017
---
# <a name="create-and-run-powershell-scripts-from-the-configuration-manager-console"></a>Configuration Manager コンソールから PowerShell スクリプトを作成して実行する

*適用対象: System Center Configuration Manager (Current Branch)*

PowerShell スクリプトを実行する機能と System Center Configuration Manager の統合を改善しました。 PowerShell には、高度な自動化されたスクリプトを作成できるという利点があります。PowerShell スクリプトは、多くの方が参加するコミュニティで理解され、共有されています。 PowerShell スクリプトを使用すると、ソフトウェアを管理するカスタム ツールを簡単に構築できます。また、大規模なジョブをより簡単に、一貫した方法で実行できるので、日常のタスクをすぐに完了できるようになります。

PowerShell スクリプトは System Center Configuration Manager と統合されているので、*スクリプトの実行*機能を使用して以下を実行できます。

- Configuration Manager と共に使用するようにスクリプトを作成して編集する。
- ロールとセキュリティ スコープを使用してスクリプトの使用法を管理する。  
- コレクションまたは個々のオンプレミスの管理対象 Windows PC でスクリプトを実行する。
- クライアント デバイスから高速に集計されたスクリプト結果を取得する。
- スクリプトの実行を監視し、スクリプトの出力からレポート結果を表示する。

>[!IMPORTANT]
>スクリプトを利用する場合は、目的を持って注意して使用することをお勧めします。 分離されたロールとスコープという、開発時に役立つ追加の保護策も組み込まれています。 意図しないスクリプトの実行を防ぐために、実行前にスクリプトが正しいことを検証し、信頼できる発行元のスクリプトであることを確認してください。 拡張文字や他の難読化を配慮し、スクリプトのセキュリティ保護について学習してください。

>[!TIP]
>PowerShell スクリプトはバージョン 1706 で導入されたプレリリース機能です。 スクリプトを有効にする方法については、「[System Center Configuration Manager のプレリリース機能](/sccm/core/servers/manage/pre-release-features)」を参照してください。

## <a name="prerequisites"></a>必要条件

- PowerShell スクリプトを実行するには、クライアントで PowerShell バージョン 3.0 以降を実行している必要があります。 ただし、実行するスクリプトに、より新しいバージョンの PowerShell の機能が含まれている場合、スクリプトを実行するクライアントがそのバージョンの PowerShell を実行している必要があります。
- Configuration Manager クライアントがスクリプトを実行するには、1706 リリース以降のクライアントを実行している必要があります。
- スクリプトを使用するには、適切な Configuration Manager のセキュリティ ロールのメンバーである必要があります。
- スクリプトをインポートおよび作成するには: **完全な権限を持つ管理者**のセキュリティ ロールで、**SMS スクリプト**への**作成**アクセス許可がアカウントに付与されている必要があります。
- スクリプトを承認または拒否するには: **完全な権限を持つ管理者**のセキュリティ ロールで、**SMS スクリプト**への**承認**アクセス許可がアカウントに付与されている必要があります。
- スクリプトを実行するには: **コンプライアンス設定マネージャー**のセキュリティ ロールで、**コレクション**への**スクリプトの実行**アクセス許可がアカウントに付与されている必要があります。

Configuration Manager のセキュリティ ロールの詳細については、「[ロール ベース管理の基礎](/sccm/core/understand/fundamentals-of-role-based-administration)」を参照してください。

## <a name="limitations"></a>制限事項

現在、スクリプトの実行は以下をサポートしています。

- スクリプト言語: PowerShell
- パラメーターの型: 整数、文字列

## <a name="run-script-authors-and-approvers"></a>スクリプトの実行の作成者と承認者

スクリプトの実行では、スクリプトの実装と実行に別のロールとして*スクリプト作成者*と*スクリプト承認者*の概念を使用しています。 作成者ロールと承認者ロールが分かれているので、スクリプトの実行という強力なツールの重要なプロセス チェックが可能になります。

### <a name="scripts-roles-control"></a>スクリプト ロールの制御

既定では、ユーザーは自分が作成したスクリプトを承認できません。 スクリプトは強力で用途が広く、多くのデバイスに展開できるため、スクリプトを作成する人と、そのスクリプトを承認する人とでロールを分けることができます。 ロールを分けることで、監視なしのスクリプト実行に対してセキュリティ レベルがさらに高くなります。 テストの場合は、便宜的にこの 2 つ目の承認を無効にすることもできます。

### <a name="approve-or-deny-a-script"></a>スクリプトの承認または拒否

スクリプトを実行するには、*スクリプト承認者*ロールが事前に承認する必要があります。 スクリプトを承認するには、次の手順を実行します。

1. Configuration Manager コンソールで、**[ソフトウェア ライブラリ]**をクリックします。
2. **[ソフトウェア ライブラリ]** ワークスペースで **[スクリプト]** をクリックします。
3. **[スクリプト]** リストで、承認または拒否するスクリプトを選択し、**[ホーム]** タブの **[スクリプト]** グループで、**[承認]/[拒否]** をクリックします。
4. **[スクリプトの承認/拒否]** ダイアログ ボックスで、スクリプトの **[承認]** または **[拒否]** を選択し、必要に応じて決定に関するコメントを入力します。  スクリプトを拒否すると、クライアント デバイスでそのスクリプトを実行できません。 <br>
![スクリプト - 承認](./media/run-scripts/RS-approval.png)
5. ウィザードを完了します。 **[スクリプト]** リストの **[承認状態]** 列は、行った操作に応じて変わります。

### <a name="allow-users-to-approve-their-own-scripts"></a>ユーザーが自身のスクリプトを承認できるようにする

この承認は、主にスクリプト開発のテスト フェーズで使用されます。

1. Configuration Manager コンソールで、**[管理]** をクリックします。
2. **[管理]** ワークスペースで **[サイトの構成]** を展開して、**[サイト]** をクリックします。
3. サイトの一覧で、自分のサイトを選択し、**[ホーム]** タブの **[サイト]** グループで **[階層設定]** をクリックします。
4. **[階層設定のプロパティ]** ダイアログ ボックスの **[全般]** タブで、**[Do not allow script authors to approve their own scripts]\(スクリプト作成者に自身のスクリプトの承認を許可しない\)** チェック ボックスをオフにします。

>[!IMPORTANT]
>ベスト プラクティスとして、スクリプト作成者に自分のスクリプトの承認を許可しないようにする必要があります。 これは、ラボ環境でのみ許可する必要があります。 運用環境でこの設定を変更する場合の影響を慎重に検討してください。

## <a name="security-scopes"></a>セキュリティ スコープ
*(バージョン 1710 で導入されました)*  
スクリプトの実行は、Configuration Manager の既存の機能であるセキュリティ スコープを使用し、ユーザー グループを表すタグを割り当てることで、スクリプトの作成と実行を制御しています。 セキュリティ スコープの使用の詳細については、「[System Center Configuration Manager のロール ベース管理の構成](../../core/servers/deploy/configure/configure-role-based-administration.md)」を参照してください。

## <a name="create-a-script"></a>スクリプトの作成

1. Configuration Manager コンソールで、**[ソフトウェア ライブラリ]**をクリックします。
2. **[ソフトウェア ライブラリ]** ワークスペースで **[スクリプト]** をクリックします。
3. **[ホーム]** タブの **[作成]** グループで、**[スクリプトの作成]** をクリックします。
4. **スクリプトの作成**ウィザードの **[スクリプト]** ページで、次の設定を構成します。
    - **[スクリプト名]**: スクリプトの名前を入力します。 同じ名前の複数のスクリプトを作成できますが、重複する名前を使用すると、Configuration Manager コンソールで必要なスクリプトを見つけるのがより困難になります。
    - **[スクリプト言語]**: 現時点では、PowerShell スクリプトのみがサポートされています。
    - **[インポート]**: PowerShell スクリプトをコンソールにインポートします。 スクリプトは **[スクリプト]** フィールドに表示されます。
    - **[クリア]**: [スクリプト] フィールドから現在のスクリプトを削除します。
    - **[スクリプト]**: 現在インポートされたスクリプトが表示されます。 必要に応じて、このフィールドでスクリプトを編集できます。
1. ウィザードを完了します。 新しいスクリプトが**[承認を待っています]**の状態で **[スクリプト]** リストに表示されます。 このスクリプトをクライアント デバイスで実行するには、先にそのスクリプトを承認する必要があります。

## <a name="script-parameters"></a>スクリプト パラメーター
*(バージョン 1710 で導入されました)*  
スクリプトにパラメーターを追加すると、作業の柔軟性が向上します。 ここでは、スクリプトの実行機能の現在の機能とスクリプト パラメーター (*文字列*、*整数*データ型) の概要について説明します。 プリセット値の一覧も掲載します。 スクリプトにサポートされないデータ型が含まれている場合は、警告を受け取ります。

**[スクリプトの作成]** ダイアログの **[スクリプト]** で **[スクリプト パラメーター]** をクリックします。

スクリプトの各パラメーターには独自のダイアログがあり、詳細や検証を追加できます。

### <a name="parameter-validation"></a>パラメーターの検証

スクリプト内の各パラメーターには、そのパラメーターに検証を追加するための **[Script Parameter Properties]\(スクリプト パラメーター プロパティ\)** ダイアログがあります。 検証を追加した後に、その検証を満たしていないパラメーターの値を入力すると、エラーが発生します。

#### <a name="example-firstname"></a>例: FirstName

この例では、文字列パラメーター *FirstName* のプロパティを設定できます。 **カスタム エラー**には、省略可能なフィールドがあります。 このフィールドは、特定のフィールドに関するユーザー ガイダンスや、文字列パラメーター (この例では *FirstName*) の使用に関するユーザー向けのガイダンスを追加する場合に便利です。

![スクリプトのパラメーター - 文字列](./media/run-scripts/RS-parameters-string.png)

## <a name="script-examples"></a>スクリプトの例

この機能で利用する可能性があるスクリプトの例をいくつか紹介します。

### <a name="create-a-folder"></a>フォルダーを作成する

``` powershell
New-Item "c:\scripts" -type folder name
```

### <a name="create-a-file"></a>ファイルを作成する

```powershell
New-Item "c:\scripts\new_file.txt" -type file name
```

### <a name="ping-a-given-computer"></a>特定のコンピューターに ping 送信する

このスクリプトは文字列を受け取り、*ping* 操作のパラメーターとして使用します。

``` powershell
Param
(
 [String][Parameter(Mandatory=$True, Position=1)] $Computername
)

Ping $Computername
```

### <a name="get-battery-status"></a>バッテリのステータスを取得する

このスクリプトは、WMI を使用してコンピューターにバッテリのステータスを照会します。

``` powershell
Write-Output (Get-WmiObject -Class Win32_Battery).BatteryStatus

```

## <a name="run-a-script"></a>スクリプトの実行

スクリプトが承認されたら、選択したコレクションに対してそのスクリプトを実行できます。 スクリプトの実行が開始されると、高い優先度のシステムを使用してすばやく起動され、1 時間以内に実行されます。 スクリプトの結果は、低速な状態メッセージ システムを使用して返されます。

1. Configuration Manager コンソールで、**[資産とコンプライアンス]** をクリックします。
2. [資産とコンプライアンス] ワークスペースで **[デバイス コレクション]** をクリックします。
3. **[デバイス コレクション]** リストで、スクリプトを実行するデバイスのコレクションをクリックします。
4. **[ホーム]** タブの **[すべてのシステム]** グループで、**[スクリプトの実行]**をクリックします。
5. **スクリプトの実行**ウィザードの **[スクリプト]** ページで、リストからスクリプトを選択します。 承認済みスクリプトのみが表示されます。
6. **[次へ]** をクリックして、ウィザードを完了します。

>[!IMPORTANT]
>ターゲット クライアントの電源が切れているなどの理由で、スクリプトが 1 時間以内に実行されない場合は、再実行する必要があります。

### <a name="target-machine-execution"></a>ターゲット コンピューターの実行
スクリプトは、対象となるクライアントの*システム* アカウントまたは*コンピューター* アカウントとして実行されます。 このアカウントのネットワーク アクセスは制限されています。 スクリプトによるリモート システムおよびリモートの場所へのアクセスは、その点を考慮して準備する必要があります。

## <a name="work-flow-and-monitoring"></a>ワーク フローと監視

ここでは、スクリプトの実行を作成、承認、実行、監視というワーク フローとして見た場合について説明します。

![スクリプトの実行 - ワーク フロー](./media/run-scripts/RS-run-scripts-work-flow.png)

### <a name="script-monitoring"></a>スクリプトの監視

デバイスのコレクション上でスクリプトの実行を開始した後は、次の手順で操作を監視します。 バージョン 1710 以降、スクリプトの実行時にリアルタイムで監視し、特定のスクリプトの実行についてレポートに返すこともできるようになりました。

1. Configuration Manager コンソールで、**[監視]** をクリックします。
2. **[監視]** ワークスペースで、**[スクリプトのステータス]** をクリックします。 ![スクリプト モニター - スクリプトの実行のステータス](./media/run-scripts/RS-monitoring-three-bar.png)
3. **[スクリプトのステータス]** リストには、クライアント デバイスで実行した各スクリプトの結果が表示されます。 スクリプトの終了コード **0** は、通常、スクリプトが正常に実行されたことを示します。

## <a name="see-also"></a>関連項目

- [System Center Configuration Manager のロール ベース管理の構成](../../core/servers/deploy/configure/configure-role-based-administration.md)
- [ロール ベース管理の基礎](/sccm/core/understand/fundamentals-of-role-based-administration)

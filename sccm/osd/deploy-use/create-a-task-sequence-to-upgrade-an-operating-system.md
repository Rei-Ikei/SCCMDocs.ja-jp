---
title: OS の更新タスク シーケンスを作成する
titleSuffix: Configuration Manager
description: タスク シーケンスを使用して、自動的に Windows 7 以降から Windows 10 にアップグレードします。
ms.date: 04/10/2018
ms.prod: configuration-manager
ms.technology: configmgr-osd
ms.topic: conceptual
ms.assetid: 7591e386-a9ab-4640-8643-332dce5aa006
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: d35a5ea3ebde6ce6ab0934832180223c2a634541
ms.sourcegitcommit: 0b0c2735c4ed822731ae069b4cc1380e89e78933
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/03/2018
---
# <a name="create-a-task-sequence-to-upgrade-an-operating-system-in-system-center-configuration-manager"></a>System Center Configuration Manager のオペレーティング システムをアップグレードするタスク シーケンスを作成する

*適用対象: System Center Configuration Manager (Current Branch)*

Configuration Manager でタスク シーケンスを使用して、オペレーティング システムをインストール先のコンピューターで自動的にアップグレードします。 Windows 7 以降から Windows 10 に、または Windows Server 2012 以降から Windows Server 2016 にアップグレードできます。 アプリケーションまたはソフトウェア更新プログラムなど、OS のアップグレード パッケージやインストールする他のコンテンツを参照するタスク シーケンスを作成します。 オペレーティング システムをアップグレードするタスク シーケンスは、「[Windows を最新バージョンにアップグレードする](upgrade-windows-to-the-latest-version.md)」シナリオの一部です。  



##  <a name="BKMK_UpgradeOS"></a> オペレーティング システムをアップグレードするタスク シーケンスの作成  
 コンピューター上のオペレーティング システムをアップグレードするには、タスク シーケンスを作成し、タスク シーケンスの作成ウィザードで **[オペレーティング システムをアップグレード パッケージからアップグレードする]** を選択します。 ウィザードにより、オペレーティング システムのアップグレード、ソフトウェア更新プログラムの適用、アプリケーションのインストールのタスク シーケンス ステップが追加されます。 タスク シーケンスを作成する前に、以下の要件を満たす必要があります。    

-   **必須**  

     - [オペレーティング システムのアップグレード パッケージ](../get-started/manage-operating-system-upgrade-packages.md) が Configuration Manager コンソールで使用可能である必要があります。
     - Windows Server 2016 にアップグレードする場合は、オペレーティング システムのアップグレードのタスク シーケンス ステップで、**[Ignore any dismissable compatibility messages]\(互換性に関する却下可能なメッセージをすべて無視する\)** 設定を選択します。 そうしないと、アップグレードは失敗します。

-   **必須 (使用する場合)**  

    -   [ソフトウェア更新プログラム](../../sum/get-started/synchronize-software-updates.md)が Configuration Manager コンソールで同期されている必要があります。  

    -   [アプリケーション](../../apps/deploy-use/create-applications.md)が Configuration Manager コンソールに追加されている必要があります。  

#### <a name="to-create-a-task-sequence-that-upgrades-an-operating-system"></a>オペレーティング システムをアップグレードするタスク シーケンスを作成するには  

1.  Configuration Manager コンソールで、**[ソフトウェア ライブラリ]** をクリックします。  

2.  **[ソフトウェア ライブラリ]** ワークスペースで **[オペレーティング システム]** を展開して、**[タスク シーケンス]** をクリックします。  

3.  **[ホーム]** タブの **[作成]** グループで **[タスク シーケンスの作成]** をクリックして、タスク シーケンスの作成ウィザードを起動します。  

4.  **[新しいタスク シーケンスの作成]** ページで、 **[オペレーティング システムをアップグレード パッケージからアップグレードする]** をクリックしてから、 **[次へ]** をクリックします。  

5.  **[タスク シーケンス情報]** ページで次の設定を指定し、**[次へ]** をクリックします。  

    -   **タスク シーケンス名**:タスク シーケンスを識別する名前を指定します。  

    -   **説明**: タスク シーケンスによって実行されるタスクの説明を指定します。  

6.  **[Windows オペレーティング システムのアップグレード]** ページで次の設定を指定し、 **[次へ]** をクリックします。  

    -   **[アップグレード パッケージ]**: オペレーティング システムのアップグレードのソース ファイルを含むアップグレード パッケージを指定します。 **[プロパティ]** ウィンドウの情報を参照して、正しいアップグレード パッケージが選択されていることを確認できます。 詳細については、「[オペレーティング システムのアップグレード パッケージの管理](../get-started/manage-operating-system-upgrade-packages.md)」を参照してください。  

    -   **[エディション インデックス]**: 複数のオペレーティング システムのエディション インデックスをパッケージから入手できる場合、希望のエディション インデックスを選択します。 既定では、最初の項目が選択されています。  

    -   **プロダクト キー**: インストールする Windows オペレーティング システムのプロダクト キーを指定します。 エンコードされたボリューム ライセンス キーと標準のプロダクト キーを指定できます。 エンコードされていないプロダクト キーを使用する場合は、5 文字の各グループをダッシュ (-) で区切る必要があります。 例: *XXXXX-XXXXX-XXXXX-XXXXX-XXXXX* ボリューム ライセンス版のアップグレードの場合は、プロダクト キーは必要ありません。 製品版の Windows のアップグレードの場合のみ、プロダクト キーが必要です。  

    -   **[Ignore any dismissable compatibility messages]\(互換性に関する却下可能なメッセージをすべて無視する\)**: Windows Server 2016 にアップグレードする場合は、この設定を選択します。 この設定を選択しないと、Windows アプリの互換性ダイアログで、ユーザーが **[確認]** をクリックするのを Windows セットアップが待機してしまうため、タスク シーケンスを完了できません。   

7.  **[更新プログラムを含める]** ページで、必要なソフトウェア更新プログラムまたはすべてのソフトウェア更新プログラムをインストールするか、まったくインストールしないかを指定します。 **[次へ]** をクリックします。 ソフトウェア更新プログラムをインストールするように指定する場合、Configuration Manager は、セットアップ先のコンピューターがメンバーとなっているコレクション向けのソフトウェア更新プログラムのみをインストールします。  

8.  **[アプリケーションのインストール]** ページで、展開先コンピューターにインストールするアプリケーションを指定してから、**[次へ]** をクリックします。 複数のアプリケーションを指定する場合は、特定のアプリケーションのインストールに失敗したときにタスク シーケンスを続行するかどうかも指定することができます。  

9. ウィザードを完了します。  


 > [!Important] 
 > タスク シーケンスの完了時に、クライアントは、コンピューターが再起動されるまで後処理およびロールバック スクリプトを削除しません。 これらのスクリプト ファイルには、機密情報は含めないでください。  


 > [!Note]
 > バージョン 1802 以降、Windows 10 の一括アップグレード用の既定のタスク シーケンス テンプレートに、アップグレード プロセスの前後に追加する推奨アクションを含む追加グループが含まれます。 これらのアクションは、Windows 10 にデバイスを正常にアップグレードしている多くのユーザーに共通するものです。 詳細については、[アップグレードの準備](#recommended-task-sequence-steps-to-prepare-for-upgrade)および[処理後](#recommended-task-sequence-steps-for-post-processing)の推奨されるタスク シーケンス ステップを参照してください。



## <a name="configure-pre-cache-content"></a>コンテンツの事前キャッシュを構成する
<!--1021244-->
タスク シーケンスの利用可能な展開について、事前キャッシュ機能を使用することで、ユーザーがタスク シーケンスをインストールする前に、関連する OS アップグレード パッケージ コンテンツをクライアントにダウンロードさせることができます。  

> [!TIP]  
> この機能はバージョン 1702 で[プレリリース機能](/sccm/core/servers/manage/pre-release-features)として初めて導入されました。 1706 以降のバージョンでは、この機能はプレリリース機能ではありません。  


> [!Note]  
> Configuration Manager では、このオプション機能は既定で無効です。 この機能は、使用する前に有効にする必要があります。 詳細については、「[更新プログラムのオプション機能の有効化](/sccm/core/servers/manage/install-in-console-updates#bkmk_options)」を参照してください。<!--505213-->  


たとえば、すべてのユーザーに対して、1 つのインプレース アップグレード タスク シーケンスのみを作成して、多くのアーキテクチャと言語を使用できます。 以前のバージョンでは、ユーザーがソフトウェア センターから利用可能なタスク シーケンスの展開をインストールするときに、コンテンツのダウンロードが開始されます。 この遅延のため、インストールできる状態になるまでさらに時間がかかります。 タスク シーケンスで参照されているすべてのコンテンツがダウンロードされます。 このコンテンツには、すべての言語とアーキテクチャ用のオペレーティング システム アップグレード パッケージが含まれます。 各アップグレード パッケージのサイズが約 3 GB の場合、コンテンツ全体が非常に大きくなります。

コンテンツの事前キャッシュ機能には、クライアントが展開を受信してすぐに適用可能な OS アップグレード パッケージ、および他のすべての参照されるコンテンツをダウンロードできるようにするオプションが用意されています。 ユーザーがソフトウェア センターで **[インストール]** をクリックすると、コンテンツはローカルのハード ドライブ上にあるため、コンテンツは準備完了の状態にあり、インストールが迅速に開始されます。

 > [!NOTE]
 > 現在この動作は、OS アップグレード パッケージにのみ適用されます。 そのパッケージは、対応するアーキテクチャまたは言語を指定する唯一のコンテンツです。 たとえば、タスク シーケンスが複数のドライバー パッケージも参照する場合、クライアントは現在、それらをすべてダウンロードします。 タスク シーケンス エンジンは、事前にではなく、タスク シーケンスを実行する際に条件を評価します。 クライアントは、パッケージのプロパティのタグを使って、事前にキャッシュに入れる対象のコンテンツを判断します。

### <a name="to-configure-the-pre-cache-feature"></a>事前キャッシュ機能を構成するには

1. 特定のアーキテクチャおよび言語に対応した OS アップグレード パッケージを作成します。 パッケージの **[データ ソース]** タブでアーキテクチャと言語を指定します。 言語については、10 進変換を使用します。 たとえば、1033 は英語を表す 10 進数値です。これを 16 進数で表すと 0x0409 となります。

    クライアントは、アーキテクチャと言語の値を評価し、事前キャッシュ中にダウンロードする OS アップグレード パッケージを決定します。

1. さまざまな言語およびアーキテクチャに対して条件付きステップを適用するタスク シーケンスを作成します。 たとえば、次の手順では英語版が使用されます。

    ![ENU、DEU、JPN の複数の OS アップグレード ステップを示すタスク シーケンス エディター](../media/precacheproperties2.png)

    ![ロケールおよび OSArchitecture の WMI WQL クエリを表示しているタスク シーケンス エディターの [オプション] タブ](../media/precacheoptions2.png)  

3. タスク シーケンスを展開します。 事前キャッシュの機能については、次の設定を構成します。
    - **[全般]** タブで、**[このタスク シーケンス用のコンテンツを事前にダウンロードする]** を選択します。
    - **[展開設定]** タブで、**[目的]** を **[利用可能]** にしてタスク シーケンスを構成します。
    - **[スケジュール]** タブの **[この展開が使用可能になる日時を指定する]** 設定については、現在選択されている時間を選択します。 クライアントは、展開の利用可能な時間にコンテンツの事前キャッシュを開始します。 対象となるクライアントがこのポリシーを受け取ると、利用可能な時間が過去の時間となるため、すぐにダウンロードの事前キャッシュが開始されます。 クライアントがこのポリシーを受け取っても、利用可能な時間が未来の時間である場合、クライアントは利用可能な時間になるまでコンテンツの事前キャッシュを開始しません。 
    - **[配布ポイント]** タブで、**[展開オプション]** 設定を構成します。 ユーザーがインストールを開始する前にコンテンツを事前キャッシュしない場合は、クライアントはこれらの設定を使用します。
  

### <a name="user-experience"></a>ユーザー側の表示と操作
- クライアントが、展開ポリシーを受け取ると、展開の利用可能な時間後にコンテンツの事前キャッシュを開始します。 このコンテンツには、すべての参照先のパッケージが含まれていますが、パッケージのアーキテクチャと言語の属性と一致する OS アップグレード パッケージのみです。
- クライアントでユーザーが展開を利用できるようになったときに、ユーザーに新しい展開について知らせる通知が表示されます。 これで、タスク シーケンスはソフトウェア センターで表示されます。 ユーザーはソフトウェア センターに移動し、**[インストール]** をクリックしてインストールを開始します。
- ユーザーがタスク シーケンスをインストールしたときにコンテンツが完全に事前キャッシュされない場合、クライアントは、展開の **[展開オプション]** タブで指定された設定を使用します。 



## <a name="recommended-task-sequence-steps-to-prepare-for-upgrade"></a>アップグレードを準備する推奨されるタスク シーケンスのステップ

バージョン 1802 以降、Windows 10 の一括アップグレード用の既定のタスク シーケンス テンプレートに、アップグレード プロセスの前に追加する推奨アクションを含む追加グループが含まれます。 **[アップグレードの準備]** グループのこれらのアクションは、Windows 10 にデバイスを正常にアップグレードしている多くのユーザーに共通するものです。 1802 より前のバージョンのサイトでは、**[アップグレードの準備]** グループでタスク シーケンスに手動でこれらのアクションを追加します。
- **[バッテリのチェック]**: コンピューターがバッテリを使っているか、または有線の電源を使っているかを確認するには、このグループにステップを追加します。 このアクションには、このチェックを実行するためのカスタム スクリプトまたはユーティリティが必要です。
- **[ネットワーク接続およびワイヤード接続のチェック]**: コンピューターがネットワークに接続されているか、またワイヤレス接続を使っていないかどうかを確認するには、このグループにステップを追加します。 このアクションには、このチェックを実行するためのカスタム スクリプトまたはユーティリティが必要です。
- **[互換性のないアプリケーションを削除する]**: このバージョンの Windows 10 と互換性がないすべてのアプリケーションを削除するには、このグループにステップを追加します。 アプリケーションをアンインストールする方法はさまざまです。 アプリケーションが Windows インストーラーを使っている場合は、アプリケーションの Windows インストーラー展開の種類プロパティの **[プログラム]** タブから、**[アンインストール プログラム]** コマンド ラインをコピーします。 そして、アンインストール プログラムのコマンド ラインの **[コマンド ラインの実行]** ステップを、このグループに追加します。 次に例を示します。 </br>`msiexec /x {150031D8-1234-4BA8-9F52-D6E5190D1CBA} /q`</br> 
- **[互換性のないドライバーを削除する]**: このバージョンの Windows 10 と互換性がないすべてのドライバーを削除するには、このグループにステップを追加します。
- **[サード パーティ セキュリティの削除/停止]**: ウイルス対策ソフトウェアなど、サード パーティのセキュリティ プログラムを削除または中断するには、このグループにステップを追加します。
   - サード パーティのディスク暗号化プログラムを使っている場合は、**/ReflectDrivers** [コマンド ライン オプション](/windows-hardware/manufacture/desktop/windows-setup-command-line-options)で、Windows セットアップにその暗号化ドライバーを提供します。 [[タスク シーケンス変数の設定]](/sccm/osd/understand/task-sequence-steps#BKMK_SetTaskSequenceVariable) ステップを、このグループのタスク シーケンスに追加します。 タスク シーケンス変数を **OSDSetupAdditionalUpgradeOptions** に設定します。 値をドライバーへのパス **/ReflectDriver** に設定します。 この[タスク シーケンス アクション変数](/sccm/osd/understand/task-sequence-action-variables#upgrade-operating-system)をタスク シーケンスで使われる Windows セットアップ コマンド ラインに追加します。 このプロセスの他のガイダンスについては、ソフトウェアの製造元にお問い合わせください。

### <a name="download-package-content-task-sequence-step"></a>パッケージ コンテンツのダウンロードのタスク シーケンスのステップ  
 以下のシナリオでは、**オペレーティング システムのアップグレード**のステップの前に、[パッケージ コンテンツのダウンロード](../understand/task-sequence-steps.md#BKMK_DownloadPackageContent)のステップを使用できます。  

-   X86 と x64 の両方のプラットフォームで 1 つのアップグレード タスク シーケンスを使用します。 **[アップグレードの準備]** グループで 2 つの **[パッケージ コンテンツのダウンロード]** ステップを含めます。 クライアント アーキテクチャを検出するために各ステップで条件を設定します。 この条件により、ステップでは適切なオペレーティング システム アップグレード パッケージのみがダウンロードされるようになります。 同じ変数を使用するようにそれぞれの **[パッケージ コンテンツのダウンロード]** ステップを構成して、 **[オペレーティング システムのアップグレード]** ステップ上のメディア パスにその変数を使用します。  

-   該当するドライバー パッケージを動的にダウンロードするには、ドライバー パッケージごとに適切なハードウェアの種類を検出する条件を含む 2 つの **[パッケージ コンテンツのダウンロード]** ステップを使用します。 同じ変数を使用するように **[パッケージ コンテンツのダウンロード]** ステップをそれぞれ構成します。 その後、**[オペレーティング システムのアップグレード]** ステップのドライバー セクションの **[ステージング済みコンテンツ]** 値でその変数を使用します。  

   > [!NOTE]
   > 複数のパッケージがある場合は、Configuration Manager によって、数字のサフィックスが変数名に追加されます。 たとえば、カスタム変数として変数 %mycontent% を指定した場合、この場所はクライアントが参照されているすべてのコンテンツを格納する場所となります。 **[オペレーティング システムのアップグレード]** などのサブシーケンス ステップで変数を参照するときに、数字のサフィックスと共にこの変数を使用します。 この例では、%mycontent01% または %mycontent02% のようになります。この数字は、**[パッケージ コンテンツのダウンロード]** ステップでこの特定のコンテンツがリストされる順序に対応しています。



## <a name="recommended-task-sequence-steps-for-post-processing"></a>推奨される処理後のタスク シーケンス ステップ   
 タスク シーケンスを作成した後で、これらの追加ステップを、**後処理**のタスク シーケンスのグループに追加します。  

> [!NOTE]  
>  このタスク シーケンスは直線的ではありません。 タスク シーケンスの結果に影響を与えるステップの条件があります。 この動作は、クライアント コンピューターを正常にアップグレードするかどうか、または元の OS にクライアント コンピューターをロールバックする必要があるかによって異なります。  

バージョン 1802 以降、Windows 10 の一括アップグレード用の既定のタスク シーケンス テンプレートに、アップグレード プロセスの後に追加する推奨アクションを含む追加グループが含まれます。 **[後処理]** グループのこれらのアクションは、Windows 10 にデバイスを正常にアップグレードしている多くのユーザーに共通するものです。 1802 より前のバージョンのサイトでは、**[後処理]** グループでタスク シーケンスに手動でこれらのアクションを追加します。
- **[セットアップ ベースのドライバーを適用する]**: パッケージからセットアップ ベースのドライバー (.exe) をインストールするには、このグループにステップを追加します。
- **[サード パーティ セキュリティのインストール/有効化]**: ウイルス対策ソフトウェアなど、サードパーティ製のセキュリティ プログラムをインストールするか有効にするには、このグループにステップを追加します。 
- **[Windows の既定のアプリと関連付けを設定する]**: Windows の既定のアプリとファイルの関連付けを設定するには、このグループにステップを追加します。 最初に、必要なアプリの関連付けで参照コンピューターを準備します。 それから、次のコマンドを実行してエクスポートします。 </br>`dism /online /Export-DefaultAppAssociations:"%UserProfile%\Desktop\DefaultAppAssociations.xml"`</br>XML ファイルをパッケージに追加します。 [[コマンド ラインの実行]](/sccm/osd/understand/task-sequence-steps#BKMK_RunCommandLine) ステップをこのグループに追加します。 XML ファイルを含むパッケージを指定し、次のコマンド ラインを指定します。 </br>`dism /online /Import-DefaultAppAssociations:DefaultAppAssocations.xml`</br> 詳細については、「[Export or import default application associations](/windows-hardware/manufacture/desktop/export-or-import-default-application-associations)」(既定のアプリケーションの関連付けをエクスポートまたはインポートする) を参照してください。
- **[Apply customizations and personalization]\(カスタマイズと個人用設定を適用する\)**: プログラム グループの整理など、[スタート] メニューのカスタマイズを適用するには、このグループにステップを追加します。 詳細については、「[Customize the Start screen](/windows-hardware/manufacture/desktop/customize-the-start-screen)」(スタート画面をカスタマイズする) を参照してください。



## <a name="optional-task-sequence-steps-for-rollback"></a>オプションのロールバックのタスク シーケンスのステップ  
 コンピューターの再起動後にアップグレード プロセスで問題が生じると、Windows セットアップはアップグレードを前のオペレーティング システムにロールバックします。 その後、タスク シーケンスは**ロールバック** グループのすべてのステップを続行します。 タスク シーケンスの作成後、ロールバック グループにオプションのステップを追加することができます。 たとえば、互換性のないソフトウェアをアンインストールするなど、[アップグレードの準備] グループで、システムに加えられた変更を取り消します。



## <a name="additional-recommendations"></a>その他の推奨事項
- Windows のドキュメント「[Windows 10 のアップグレード エラーの解決](/windows/deployment/upgrade/resolve-windows-10-upgrade-errors)」を参照してください。 この記事には、アップグレード プロセスに関する詳細情報も含まれています。
- 既定の **[準備の確認]** ステップで、**[最小空きディスク容量 (MB) を満たすことを確認する]** を有効にします。 値を、32 ビット OS のアップグレード パッケージの場合は **16384** (16 GB) 以上、64 ビットの場合は **20480** (20 GB) 以上に設定します。 
- **SMSTSDownloadRetryCount** [組み込みタスク シーケンス変数](/sccm/osd/understand/task-sequence-built-in-variables)を使って、ポリシーのダウンロードを再試行します。 現在の既定では、クライアントは 2 回再試行します。この変数は 2 に設定されます。 クライアントが企業ネットワークに有線接続されていない場合は、再試行回数を増やすと、クライアントがポリシーを取得するのに役立ちます。 この変数を使っても、ポリシーをダウンロードできない場合の障害の遅延以外に、悪影響はありません。<!-- 501016 --> また、**SMSTSDownloadRetryDelay** 変数を既定値の 15 秒から増やします。
- インラインの互換性評価を実行します。 
   - **[アップグレードの準備]** グループの早い段階に、第 2 の **[オペレーティング システムのアップグレード]** ステップを追加します。 その名前を "*アップグレード評価*" にします。 同じアップグレード パッケージを指定し、**[アップグレードを開始せずに Windows セットアップの互換性スキャンを実行する]** オプションを有効にします。 [オプション] タブで **[エラー時に続行する]** を有効にします。 
   - この "*アップグレード評価*" ステップの直後に、**[コマンド ラインの実行]** ステップを追加します。 次のコマンド ラインを指定します。</br> `cmd /c exit %_SMSTSOSUpgradeActionReturnCode%`</br>**[オプション]** タブで、次の条件を追加します。 </br>`Task Sequence Variable _SMSTSOSUpgradeActionReturnCode not equals 3247440400` </br>このリターン コードは MOSETUP_E_COMPAT_SCANONLY (0xC1900210) に相当する 10 進数で、互換性スキャンが成功して問題がなかったことを示します。 "*アップグレード評価*" ステップが成功してこのコードを返した場合、このステップはスキップされます。 評価ステップが他のリターン コードを返した場合、このステップは Windows セットアップ互換性スキャンからのリターン コードでタスク シーケンスを失敗させます。
   - 詳細については、「[オペレーティング システムのアップグレード](/sccm/osd/understand/task-sequence-steps#BKMK_UpgradeOS)」を参照してください。
- このタスク シーケンスの間にデバイスを BIOS から UEFI に変更する場合は、「[インプレース アップグレード時に BIOS から UEFI に変換する](/sccm/osd/deploy-use/task-sequence-steps-to-manage-bios-to-uefi-conversion#convert-from-bios-to-uefi-during-an-in-place-upgrade)」を参照してください。
